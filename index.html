<!DOCTYPE html>
<html>
<head>
  <title>Solana Token Transfer DApp</title>
  <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@solana/spl-token@latest/lib/cjs/index.min.js"></script>
<script type="module" src="https://cdn.jsdelivr.net/npm/@solana/spl-token-registry@0.2.4574/+esm"> </script>
</head>
<body>
  <h1>Solana Token Transfer</h1>
  <div>
    <label for="tokenAddress">Token Address:</label>
    <input type="text" id="tokenAddress" placeholder="Enter token address">
  </div>
  <div>
    <label for="receiverAddress">Receiver Address:</label>
    <input type="text" id="receiverAddress" placeholder="Enter receiver address">
  </div>
  <div>
    <label for="amount">Amount:</label>
    <input type="number" id="amount" placeholder="Enter amount">
  </div>
  <button id="connectWallet">Connect Wallet</button>
  <button id="transferTokens" disabled>Transfer Tokens</button>
  <div id="status"></div>
  <script type="module">
    const connectButton = document.getElementById("connectWallet");
    const transferButton = document.getElementById("transferTokens");
    const statusElement = document.getElementById("status");

    connectButton.addEventListener("click", async () => {
      try {
        const connection = new solanaWeb3.Connection("https://api.mainnet-beta.solana.com");
        const provider = window.solana; // Access wallet provider globally
        const wallet = await provider.connect();
        const publicKey = wallet.publicKey.toBase58();
        statusElement.textContent = `Connected to wallet: ${publicKey}`;
        transferButton.disabled = false;

        // Check for token metadata (optional)
        const tokenAddress = document.getElementById("tokenAddress").value;
        const tokenMetadata = await splTokenRegistry.getMint(connection, tokenAddress);
        // Display token name, symbol, decimals (optional)
        console.log("Token Metadata:", tokenMetadata);
      } catch (error) {
        console.error("Error connecting to wallet:", error);
        statusElement.textContent = "Wallet connection failed";
      }
    });

    transferButton.addEventListener("click", async () => {
      try {
        const tokenAddress = document.getElementById("tokenAddress").value;
        const receiverAddress = document.getElementById("receiverAddress").value;
        const amount = parseInt(document.getElementById("amount").value);

        const connection = new solanaWeb3.Connection("https://api.mainnet-beta.solana.com");
        const provider = window.solana;
        const wallet = await provider.connect();

        const tokenPublicKey = new solanaWeb3.PublicKey(tokenAddress);
        const receiverPublicKey = new solanaWeb3.PublicKey(receiverAddress);

        // Check for source (sender's) ATA
        const sourceAccount = await connection.getTokenAccountsByOwner(
          wallet.publicKey,
          { mint: tokenPublicKey }
        );

        let sourceAddress;
        if (sourceAccount.value.length > 0) {
          // Use existing source ATA if found
          sourceAddress = sourceAccount.value[0].pubkey;
        } else {
          statusElement.textContent = "Error: You don't have an associated token account for this token.";
          return;
        }

        // Check for and potentially create destination (receiver's) ATA
        const destAccount = await connection.getTokenAccountsByOwner(
          receiverPublicKey,
          { mint: tokenPublicKey }
        );

        let destinationAddress;
        if (destAccount.value.length > 0) {
          // Use existing destination ATA if found
          destinationAddress = destAccount.value[0].pubkey;
        } else {
          try {
            // Create destination ATA automatically
            const mint = new solanaWeb3.PublicKey(tokenAddress);
            const associatedTokenAccount = await splToken.createAssociatedTokenAccount(
              connection,
              wallet,
              mint,
              receiverPublicKey
            );
            destinationAddress = associatedTokenAccount;
          } catch (error) {
            console.error("Error creating destination token account:", error);
            statusElement.textContent = "Error creating destination token account";
            return;
          }
        }

        // Create transfer instruction
        const transaction = new solanaWeb3.Transaction().add(
          solanaWeb3.Token.createTransferInstruction(
            solanaWeb3.TOKEN_PROGRAM_ID,
            sourceAddress,
            destinationAddress,
            wallet.publicKey,
            [],
            amount
          )
        );

        // Sign and send the transaction
        const signature = await window.solana.signTransaction(transaction);
        const result = await connection.sendRawTransaction(signature);

        statusElement.textContent = `Transaction submitted: ${result}`;

        // Handle transaction confirmation and potential errors
        connection.onSignature(result, (confirmation) => {
          if (confirmation.err) {
            statusElement.textContent = `Transaction failed: ${confirmation.err}`;
          } else {
            statusElement.textContent = `Transaction confirmed`;
          }
        });
      } catch (error) {
        console.error("Error transferring tokens:", error);
        statusElement.textContent = "Transaction failed";
      }
    });
  </script>
</body>
</html>
